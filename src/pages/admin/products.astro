---
export const prerender = false;

// Proteger esta p√°gina
const session = Astro.cookies.get("session");
if (!session || session.value !== "admin") {
  return Astro.redirect("/login");
}

import Layout from "../../layouts/Layout.astro";
---

<Layout title="Agregar Producto">
  <section
    class="min-h-screen w-full flex items-center justify-center bg-gradient-to-br from-gray-900 via-gray-800 to-black py-10 px-4"
  >
    <div
      class="w-full max-w-xl bg-gray-900/70 backdrop-blur-xl border border-gray-700 shadow-2xl rounded-2xl p-8"
    >
      <h1 class="text-3xl font-bold text-center text-cyan-400 mb-6">
        Agregar nuevo producto üì¶
      </h1>

      <div class="w-full flex justify-start mb-6">
        <a
          href="/"
          class="px-5 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-xl font-semibold transition"
        >
          ‚Üê Volver al men√∫
        </a>
      </div>

      <form id="productForm" class="space-y-5">
        <div>
          <label for="name" class="block text-gray-300 mb-1"
            >Nombre del art√≠culo</label
          >
          <input
            id="name"
            type="text"
            required
            class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-gray-700 focus:border-cyan-400 outline-none transition"
          />
        </div>

        <div>
          <label for="description" class="block text-gray-300 mb-1"
            >Descripci√≥n</label
          >
          <textarea
            id="description"
            required
            rows="3"
            class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-gray-700 focus:border-cyan-400 outline-none transition"
          ></textarea>
        </div>

        <div>
          <label for="price" class="block text-gray-300 mb-1">Precio</label>
          <input
            id="price"
            type="number"
            required
            class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-gray-700 focus:border-cyan-400 outline-none transition"
          />
        </div>

        <div>
          <label for="category" class="block text-gray-300 mb-1"
            >Categor√≠a</label
          >
          <select
            id="category"
            required
            class="w-full px-4 py-3 bg-gray-800 text-white rounded-lg border border-gray-700 focus:border-cyan-400 outline-none transition"
          >
            <option value="Tecnolog√≠a">Tecnolog√≠a</option>
            <option value="Jugueter√≠a">Jugueter√≠a</option>
            <option value="Decoraci√≥n">Decoraci√≥n</option>
            <option value="Accesorios">Accesorios</option>
          </select>
        </div>

        <div>
          <label for="image" class="block text-gray-300 mb-1"
            >Imagen (opcional)</label
          >
          <input id="image" type="file" class="mb-4" />
        </div>

        <button
          type="submit"
          class="w-full py-3 bg-cyan-600 hover:bg-cyan-500 text-white text-lg rounded-xl font-bold transition shadow-lg hover:shadow-cyan-500/30"
        >
          Guardar producto
        </button>

        <p id="msg" class="text-green-400 mt-3 text-center" style="display:none;">
          Producto guardado correctamente! üéâ
        </p>
      </form>

      <script>
        // Importante: Este script debe ejecutarse en el cliente (client-side)
        const form = document.getElementById("productForm");
        const msg = document.getElementById("msg");

        // Ocultar mensaje al inicio y a√±adir l√≥gica de env√≠o
        msg.style.display = "none";
        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const fileInput = document.getElementById("image");
          const file = fileInput.files[0];
          let base64Image = "";

          // Funci√≥n para limpiar el mensaje de √©xito despu√©s de un tiempo
          const hideMessage = () => {
            setTimeout(() => {
              msg.style.display = "none";
            }, 3000); // Ocultar despu√©s de 3 segundos
          };

          if (file) {
            const reader = new FileReader();
            reader.onload = async () => {
              base64Image = reader.result;
              await sendData(base64Image);
              hideMessage();
            };
            reader.readAsDataURL(file);
          } else {
            await sendData("");
            hideMessage();
          }
        });

        async function sendData(image) {
          // Obtener los valores de los campos
          const data = {
            name: (document.getElementById("name") as HTMLInputElement).value,
            description: (document.getElementById("description") as HTMLTextAreaElement).value,
            price: (document.getElementById("price") as HTMLInputElement).value,
            category: (document.getElementById("category") as HTMLSelectElement).value,
            image, // La imagen en Base64 o cadena vac√≠a
          };

          // Realizar la petici√≥n POST
          const res = await fetch("/api/save-product", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          // Manejo de la respuesta
          if (res.ok) {
            msg.style.display = "block";
            form.reset(); // Limpiar formulario
          } else {
            // Manejo de error (opcional)
            console.error("Error al guardar el producto:", res.statusText);
            // Podr√≠as mostrar un mensaje de error aqu√≠
          }
        }
      </script>
    </div>
  </section>
</Layout>